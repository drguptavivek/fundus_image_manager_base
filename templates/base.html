<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>{% block title %}ZIP ‚Üí Extract ‚Üí OCR{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  {% set v = (config.get('ASSETS_VERSION') or '') %}
  <!-- Favicons -->
  <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}?v={{ v }}" sizes="any">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}?v={{ v }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}?v={{ v }}">

  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/bootstrap.min.css') }}?v={{ v }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/photoswipe.css') }}?v={{ v }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/app.css') }}?v={{ v }}">

  {% block extra_styles %}

  {% endblock %}

  <!-- Theme bootstrapper: set initial theme ASAP to avoid FOUC -->
  <script>
    (function () {
      try {
        var stored = localStorage.getItem('theme');
        // Default to dark mode; user preference in localStorage wins
        var theme = stored || 'dark';
        document.documentElement.setAttribute('data-bs-theme', theme);
      } catch (e) {
        // no-op
      }
    })();
  </script>




</head>

<body
  class="bg-body d-flex flex-column min-vh-100 theme-{{ request.blueprint|default('root', true) }} {% block body_classes %}{% endblock %}">

  <nav class="navbar navbar-expand-lg theme-auto bg-body border-bottom mb-4">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center gap-2" href="{{ url_for('homepage') }}">
        <img src="{{ url_for('static', filename='retina_svg_logo.svg') }}" alt="Fundus retina logo" width="36"
          height="36" loading="eager">
        <span>Fundus Image Manager</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">

          <li class="nav-item">
            <a class="nav-link {% if request.endpoint == 'homepage' %}active{% endif %}"
              href="{{ url_for('homepage') }}">Home</a>
          </li>

          {% if current_user.is_authenticated and (current_user_has('admin') or current_user_has('fileUploader') or
          current_user_has('optometrist') or current_user_has('data_manager')) %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle
                      {{ 'active' if (request.blueprint in ['uploads','uploaded_results','jobs','audit']
                                        or (request.endpoint|default('', true)).startswith('jobs.')
                                        or (request.endpoint|default('', true)) == 'glaucoma.glaucoma_clean_workflow') else '' }}"
              href="#" id="workMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Work
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="workMenu">
              <li>
                <a class="dropdown-item {% if request.endpoint == 'uploads.upload_form' %}active{% endif %}"
                  href="{{ url_for('uploads.upload_form') }}">Upload Zips</a>
              </li>
              <li>
                <a class="dropdown-item {% if request.endpoint == 'uploaded_results.list_uploaded_results' %}active{% endif %}"
                  href="{{ url_for('uploaded_results.list_uploaded_results') }}">Uploaded ZIPs Dashboard</a>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              {% if current_user_has('contributor') or current_user_has('data_manager') or current_user_has('admin') %}
              <li>
                <a class="dropdown-item {% if request.endpoint == 'direct_uploads.upload' %}active{% endif %}"
                  href="{{ url_for('direct_uploads.upload') }}">Direct Upload</a>
              </li>
              <li>
                <a class="dropdown-item {% if request.endpoint == 'direct_uploads.dashboard' %}active{% endif %}"
                  href="{{ url_for('direct_uploads.dashboard') }}">Direct Upload Dashboard</a>
              </li>
              {% endif %}
              {% endif %}
              <li>
                <hr class="dropdown-divider">
              </li>
              {% if current_user.is_authenticated %}
              <li>
                <a class="dropdown-item {{ 'active' if (request.blueprint == 'screenings' or (request.endpoint|default('', true)).startswith('screenings.')) else '' }}"
                  href="{{ url_for('screenings.list_screenings') }}">Screenings</a>
              </li>
          
              <li>
                <a class="dropdown-item {{ 'active' if (request.endpoint|default('', true)) == 'glaucoma.glaucoma_clean_workflow' else '' }}"
                  href="{{ url_for('glaucoma.glaucoma_clean_workflow') }}">Clean Glaucoma Data</a>
              </li>
                  
              <li>
                <a class="dropdown-item {{ 'active' if request.blueprint == 'audit' else '' }}"
                  href="{{ url_for('audit.missing_capture_date') }}">Audit Dates</a>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <a class="dropdown-item {{ 'active' if (request.blueprint == 'jobs' or (request.endpoint|default('', true)).startswith('jobs.')) else '' }}"
                  href="{{ url_for('jobs.list_recent_jobs') }}">Jobs</a>
              </li>
              {% endif %}
            </ul>
          </li>

          
          {% if current_user.is_authenticated and (current_user_has('admin') or current_user_has('ophthalmologist') or current_user_has('data_manager') or current_user_has('contributor')) %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle {{ 'active' if request.blueprint in ['glaucoma', 'preprocess'] else '' }}" href="#"
              id="verifyMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Pre-processing
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="glaucomaMenu">
              <li  class="dropdown-item " style="font-weight: 800;">Glacuoma PDFs</li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <a class="dropdown-item {{ 'active' if (request.endpoint|default('', true)) == 'glaucoma.glaucoma_list' else '' }}"
                  href="{{ url_for('glaucoma.glaucoma_list') }}">Verify</a>
              </li>
              <li>
                <a class="dropdown-item {{ 'active' if (request.endpoint|default('', true)) == 'glaucoma.glaucoma_results' else '' }}"
                  href="{{ url_for('glaucoma.glaucoma_results') }}">Dashboard</a>
              </li>
              
              <li>
                <hr class="dropdown-divider">
              </li>
              <li  class="dropdown-item" style="font-weight: 800;">DR PDFs</li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <a class="dropdown-item {{ 'active' if (request.endpoint|default('', true)) == 'glaucoma.glaucoma_list' else '' }}"
                  href="{{ url_for('glaucoma.glaucoma_list') }}">Verify</a>
              </li>
              <li>
                <a class="dropdown-item {{ 'active' if (request.endpoint|default('', true)) == 'glaucoma.glaucoma_results' else '' }}"
                  href="{{ url_for('glaucoma.glaucoma_results') }}">Dashboard</a>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li  class="dropdown-item" style="font-weight: 800;">Image Anonymization</li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <a class="dropdown-item {{ 'active' if (request.endpoint|default('', true)) == 'preprocess.anonymization_dashboard' else '' }}"
                  href="{{ url_for('preprocess.anonymization_dashboard') }}">Anonymization Dashboard</a>
              </li>
            </ul>
          </li>
          {% endif %}

          {% if current_user.is_authenticated and (current_user_has('admin') or current_user_has('optometrist') or
          current_user_has('ophthalmologist')) %}
          <li class="nav-item">
            <a class="nav-link {{ 'active' if request.blueprint == 'grading' else '' }}"
              href="{{ url_for('grading.index') }}">Grading</a>
          </li>
          {% endif %}



          {# Admin dropdown (only for admin users) #}
          {% if current_user.is_authenticated and current_user_has('admin') %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle {{ 'active' if request.blueprint in ['admin','jobs'] else '' }}" href="#"
              id="adminMenu" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Admin
            </a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="adminMenu">
              <li><a class="dropdown-item" href="{{ url_for('admin.users_list') }}">Users </a></li>
              <li><a class="dropdown-item" href="{{ url_for('admin.malicious_uploads') }}">Malicious Uploads</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>

              <li><a class="dropdown-item" href="{{ url_for('admin.add_user') }}">Add user</a></li>
              <li><a class="dropdown-item" href="{{ url_for('admin.change_password') }}">Change user password</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="{{ url_for('admin.manage_roles') }}">Roles Master</a></li>

              <li>
                <a class="dropdown-item" href="{{ url_for('admin.list_and_create_lookup', model_name='hospital') }}">
                  Hospitals
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{{ url_for('admin.list_and_create_lookup', model_name='lab_unit') }}">
                  Units / Labs.
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{{ url_for('admin.list_and_create_lookup', model_name='camera') }}">
                  Devices / Cameras
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{{ url_for('admin.list_and_create_lookup', model_name='disease') }}">
                  Diseases
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="{{ url_for('admin.list_and_create_lookup', model_name='area') }}">
                  Areas
                </a>
              </li>
              <li>
                <hr class="dropdown-divider">
              </li>


              <li><a class="dropdown-item" href="{{ url_for('style_guide') }}">Style Guide</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="/healthz">Health</a></li>

            </ul>
          </li>
          {% endif %}


          {% if current_user.is_authenticated %}
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle {{ 'active' if request.blueprint == 'account' else '' }}" href="#"
              role="button" data-bs-toggle="dropdown" aria-expanded="false">
              Account
            </a>
            <ul class="dropdown-menu dropdown-menu-end">
              <li class="dropdown-header">Signed in as <strong>{{ current_user.username|default('User', true)
                  }}</strong></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li><a class="dropdown-item" href="{{ url_for('account.profile') }}">My profile</a></li>
              <li><a class="dropdown-item" href="{{ url_for('account.change_password_self') }}">Change password</a></li>
              <li>
                <hr class="dropdown-divider">
              </li>
              <li>
                <form method="post" action="{{ url_for('auth.logout') }}" class="m-0">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="dropdown-item w-100 text-start">Sign out</button>
                </form>
              </li>
            </ul>
          </li>
          {% endif %}

        </ul>
      </div>
    </div>
  </nav>

  {# Flash toasts (fixed, compact, top-right, offset under navbar) #}
  <div id="flash-toasts" class="toast-container position-fixed end-0 p-3"
    style="z-index:1200; top: var(--toast-top, 64px); --bs-toast-max-width: 300px; --bs-toast-padding-x: .5rem; --bs-toast-padding-y: .25rem;">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% for category, message in messages %}
    {% set cls = (
    'danger' if category in ['error','danger']
    else 'success' if category in ['ok','success']
    else 'warning' if category in ['warn','warning']
    else 'info'
    ) %}
    <div class="toast text-bg-{{ cls }} border-0 shadow-sm small" role="alert" aria-live="polite" aria-atomic="true"
      data-bs-autohide="true" data-bs-delay="3000">
      <div class="d-flex">
        <div class="toast-body py-1">{{ message }}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"
          aria-label="Close"></button>
      </div>
    </div>
    {% endfor %}
    {% endwith %}
  </div>


  <div class="container">
    {% from "_forms.html" import csrf_field %}
    {% block content %}

    {% endblock %}
  </div>
  <br />

  <br />

  <br />

  <br />

  <br />

  <footer class="site-footer mt-auto" style="margin-top: 2rem;">
    <div class="container py-3 d-flex flex-column flex-sm-row align-items-center justify-content-between gap-3">
      <!-- GitHub icon (left) -->
      <a class="link-body-emphasis d-inline-flex align-items-center text-decoration-none" aria-label="GitHub repository"
        href="{{ config.get('GITHUB_REPO_URL') or 'https://github.com/drguptavivek/fundus_img_xtract' }}"
        target="_blank" rel="noopener">
        <span class="d-inline-block" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 0C5.37 0 0 5.37 0 12c0 5.3 3.44 9.79 8.21 11.38.6.11.82-.26.82-.58 0-.29-.01-1.06-.02-2.08-3.34.73-4.04-1.61-4.04-1.61-.55-1.4-1.35-1.77-1.35-1.77-1.1-.76.08-.74.08-.74 1.22.09 1.86 1.25 1.86 1.25 1.08 1.85 2.84 1.31 3.53 1 .11-.78.42-1.31.76-1.61-2.67-.3-5.48-1.34-5.48-5.95 0-1.31.47-2.39 1.24-3.23-.12-.3-.54-1.5.12-3.12 0 0 1.01-.32 3.3 1.23a11.5 11.5 0 0 1 6 0c2.29-1.55 3.3-1.23 3.3-1.23.66 1.62.24 2.82.12 3.12.77.84 1.24 1.92 1.24 3.23 0 4.62-2.81 5.64-5.49 5.94.43.37.81 1.1.81 2.22 0 1.6-.01 2.89-.01 3.28 0 .32.22.7.83.58C20.56 21.79 24 17.3 24 12 24 5.37 18.63 0 12 0z" />
          </svg>
        </span>
      </a>

      <div class="small text-center text-sm-start text-body-secondary">
        &copy; Software is CC BY-NC-SA ‚Äî Dr Vivek Gupta, RP Centre, AIIMS, New Delhi. All data is Protected.
        <div class="mt-1">All logos and trademarks are the property of their respective owners.</div>
      </div>
      <div class="d-flex align-items-center gap-2"></div>
    </div>
  </footer>




  <!-- Global SVG color filters (hidden) For Images-->
  <svg width="0" height="0" style="position:absolute;left:-9999px;visibility:hidden" aria-hidden="true"
    focusable="false">
    <defs>
      <!-- Red-free: output R=G, G=G, B=G (green channel as monochrome) -->
      <filter id="pswp-greenmono" color-interpolation-filters="sRGB">
        <feColorMatrix type="matrix" values="
        0 1 0 0 0
        0 1 0 0 0
        0 1 0 0 0
        0 0 0 1 0" />
      </filter>

      <!-- Green emphasis: keep color, reduce R/B to 50% -->
      <filter id="pswp-greenboost" color-interpolation-filters="sRGB">
        <feColorMatrix type="matrix" values="
        0.5 0   0   0 0
        0   1.0 0   0 0
        0   0   0.5 0 0
        0   0   0   1 0" />
      </filter>

      <!-- Grayscale (luminosity) -->
      <filter id="pswp-gray" color-interpolation-filters="sRGB">
        <feColorMatrix type="matrix" values="
        0.2126 0.7152 0.0722 0 0
        0.2126 0.7152 0.0722 0 0
        0.2126 0.7152 0.0722 0 0
        0      0      0      1 0" />
      </filter>

      <!-- High contrast: simple contrast boost -->
      <filter id="pswp-contrast" color-interpolation-filters="sRGB">
        <!-- contrast ~1.3 around 0.5 -->
        <feComponentTransfer>
          <feFuncR type="linear" slope="1.3" intercept="-0.15" />
          <feFuncG type="linear" slope="1.3" intercept="-0.15" />
          <feFuncB type="linear" slope="1.3" intercept="-0.15" />
        </feComponentTransfer>
      </filter>

      <!-- Blue mono: output R=B, G=B, B=B -->
      <filter id="pswp-bluemono" color-interpolation-filters="sRGB">
        <feColorMatrix type="matrix" values="
      0 0 1 0 0
      0 0 1 0 0
      0 0 1 0 0
      0 0 0 1 0" />
      </filter>
    </defs>
  </svg>


  <!--  {# --- Core/vendor scripts first (e.g., bootstrap bundle, photoswipe, etc.) --- #} -->
  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}?v={{ v }}"></script>

  <!-- Global JS  -->
  <script src="{{ url_for('static', filename='js/app.js') }}?v={{ config.get('ASSETS_VERSION','') }}" defer></script>
  <script src="{{ url_for('static', filename='js/flash-toasts.js') }}?v={{ config.get('ASSETS_VERSION','') }}"
    defer></script>

  {% if current_user.is_authenticated %}
  <script id="idle-timeout-js" src="{{ url_for('static', filename='js/idle-timeout.js') }}" async data-enabled="1"
    data-timeout-min="{{ config.get('INACTIVITY_TIMEOUT_MINUTES', 30)|int }}" data-warn-lead-min="2"
    data-ping-url="{{ url_for('auth.ping') }}" data-login-url="{{ url_for('auth.login') }}">
    </script>
  {% endif %}


  <!-- {# Page-specific scripts go here #} -->
  {% block page_scripts %}

  {% endblock %}

  <!-- Floating theme toggle (fixed on right edge) -->
  <button class="btn btn-sm btn-secondary position-fixed top-50 end-0 translate-middle-y me-2 shadow-sm" type="button"
    data-theme-toggle aria-label="Toggle dark mode" title="Toggle dark mode" style="z-index:1300">
    <span data-theme-icon>üåô</span>
  </button>

  <!-- Theme + palette logic -->
  <script>
    (function () {
      function updateToggle(theme) {
        var icon = document.querySelector('[data-theme-icon]');
        if (icon) icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        var btn = document.querySelector('[data-theme-toggle]');
        if (btn) btn.setAttribute('aria-label', theme === 'dark' ? 'Switch to light mode' : 'Switch to dark mode');
      }
      function setTheme(theme) {
        document.documentElement.setAttribute('data-bs-theme', theme);
        try { localStorage.setItem('theme', theme); } catch (e) { }
        updateToggle(theme);
      }
      // initialize toggle state based on current attribute
      var current = document.documentElement.getAttribute('data-bs-theme') || 'light';
      updateToggle(current);
      document.addEventListener('click', function (e) {
        var btn = e.target.closest('[data-theme-toggle]');
        if (!btn) return;
        var cur = document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'dark' : 'light';
        setTheme(cur === 'dark' ? 'light' : 'dark');
      });

      // Removed palette switching; single Healthcare theme remains
    })();
  </script>




</body>

</html>