{% extends "base.html" %}
{% block title %}Image Grading – DR{% endblock %}

{% block content %}
{% from "_forms.html" import csrf_field %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">DR Grading</h3>
  <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('grading.index') }}">Grading Dashboard</a>
  </div>

<div class="row g-3">
  <!-- Large image on left -->
  <div class="col-12 col-lg-9">
    {% include 'grading/_viewer_card.html' %}
  </div>

  <!-- Narrow right column with stacked buttons -->
  <div class="col-12 col-lg-3">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="mb-1 small text-muted">Image UUID: <code>{{ image.uuid }}</code></div>
        <div class="mb-3 small text-muted">Date: <strong>
          {% if encounter and encounter.capture_date_dt %}
            {{ encounter.capture_date_dt.strftime('%Y-%m-%d') }}
          {% elif encounter and encounter.capture_date %}
            {{ encounter.capture_date }}
          {% else %}-{% endif %}
        </strong></div>

        <form method="post" action="{{ url_for('grading.dr_grade') }}">
          {{ csrf_field() }}
          <input type="hidden" name="ef_uuid" value="{{ image.uuid }}">
          <div class="mb-2">
            <label class="form-label">Impression</label>
            <div class="d-flex flex-column gap-2" role="group" aria-label="Impression" id="imp-group-dr">
              {% for opt in impressions %}
                {% set oid = 'dr-imp-' ~ opt.replace(' ', '-').lower() %}
                {% set btn_class = 'btn-outline-primary' %}
                {% if opt.lower().startswith('no dr') %}{% set btn_class = 'btn-success' %}{% endif %}
                {% if 'npdr' in opt.lower() %}{% set btn_class = 'btn-warning' %}{% endif %}
                {% if opt == 'PDR' %}{% set btn_class = 'btn-danger' %}{% endif %}
                {% if opt == 'Not gradable' %}{% set btn_class = 'btn-secondary' %}{% endif %}
                <input type="radio" class="btn-check" name="impression" id="{{ oid }}" value="{{ opt }}" autocomplete="off" required {% if my_grading and my_grading.impression == opt %}checked{% endif %}>
                <label class="btn {{ btn_class }} text-start w-100 d-flex justify-content-between align-items-center" for="{{ oid }}">
                  <span>{{ opt }}</span>
                  <span class="sel-icon d-none">✓</span>
                </label>
              {% endfor %}
            </div>
          </div>
          <div id="dr-ng-reasons" class="mb-3 d-none">
            <label class="form-label">Not gradable – select reason</label>
            <div class="d-flex flex-column gap-2">
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Poor focus">Poor focus</button>
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Media opacity (cataract/flare)">Media opacity (cataract/flare)</button>
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Over/underexposed">Over/underexposed</button>
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Macula not centered">Macula not centered</button>
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Inadequate field">Inadequate field</button>
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Obscured by lids/lashes">Obscured by lids/lashes</button>
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Artefacts">Artefacts</button>
              <button type="button" class="btn btn-outline-secondary btn-sm dr-ng-reason-btn" data-text="Other">Other</button>
            </div>
          </div>
          <div class="mb-2">
            <label class="form-label">Remarks (optional)</label>
            <textarea name="remarks" class="form-control form-control-sm" rows="2">{{ my_grading.remarks if my_grading and my_grading.remarks else '' }}</textarea>
          </div>
          <div class="d-flex justify-content-between gap-2">
            <button type="button" id="dr-clear-imp" class="btn btn-outline-secondary btn-sm">Clear</button>
            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-sm" name="action" value="save_close">Save & Close</button>
              <button type="submit" class="btn btn-success btn-sm" name="action" value="save_next">Save & Next</button>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mt-2">
  <div class="col-12 col-lg-3 ms-auto">
    {% if my_grading %}
    <form method="post" action="{{ url_for('grading.dr_remove') }}" onsubmit="return confirm('Remove your DR grading for this image?');">
      {{ csrf_field() }}
      <input type="hidden" name="ef_uuid" value="{{ image.uuid }}">
      <input type="hidden" name="grading_id" value="{{ my_grading.id }}">
      <button type="submit" class="btn btn-outline-danger btn-sm w-100">Remove Grading</button>
    </form>
    {% endif %}
  </div>
</div>
 
{% endblock %}
{% block page_scripts %}
<script>
  (function(){
    const group = document.getElementById('imp-group-dr');
    if (!group) return;
    const radios = group.querySelectorAll('input[type="radio"][name="impression"]');
    const labels = group.querySelectorAll('label');
    const reasons = document.getElementById('dr-ng-reasons');
    const remarks = document.querySelector('textarea[name="remarks"]');
    function syncIcons() {
      labels.forEach(l => l.querySelector('.sel-icon')?.classList.add('d-none'));
      const checked = group.querySelector('input[type="radio"][name="impression"]:checked');
      if (checked) {
        const lab = group.querySelector(`label[for="${checked.id}"]`);
        const icon = lab && lab.querySelector('.sel-icon');
        if (icon) icon.classList.remove('d-none');
        // Toggle reasons panel for Not gradable
        const val = (checked.value || '').toLowerCase();
        if (reasons) {
          if (val === 'not gradable') reasons.classList.remove('d-none');
          else reasons.classList.add('d-none');
        }
      }
    }
    radios.forEach(r => r.addEventListener('change', syncIcons));
    document.getElementById('dr-clear-imp')?.addEventListener('click', function(){
      radios.forEach(r => r.checked = false);
      labels.forEach(l => l.querySelector('.sel-icon')?.classList.add('d-none'));
      if (reasons) reasons.classList.add('d-none');
    });
    syncIcons();

    // Reason buttons append to remarks
    document.querySelectorAll('.dr-ng-reason-btn').forEach(btn => {
      btn.addEventListener('click', function(){
        const text = this.getAttribute('data-text') || '';
        if (!remarks) return;
        const cur = (remarks.value || '').trim();
        if (!cur) remarks.value = text;
        else if (!cur.toLowerCase().includes(text.toLowerCase())) remarks.value = cur + '; ' + text;
      });
    });
  })();
</script>
{% endblock %}
