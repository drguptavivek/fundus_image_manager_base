{% extends "base.html" %}
{% block title %}Grading{% endblock %}

{% block content %}
{% from "_forms.html" import csrf_field %}

{% macro badge_for_for(val) %}
  {% set v = (val or '')|lower %}
  {% if v == 'glaucoma' %}
    <span class="badge rounded-pill badge-soft-primary">Glaucoma</span>
  {% elif v == 'dr' %}
    <span class="badge rounded-pill badge-soft-info">DR</span>
  {% elif v == 'amd' %}
    <span class="badge rounded-pill badge-soft-purple">AMD</span>
  {% else %}
    <span class="badge rounded-pill badge-soft-secondary">{{ val or '-' }}</span>
  {% endif %}
{% endmacro %}

{% macro badge_for_impression(val) %}
  {% set t = (val or '') %}
  {% if t|lower == 'normal' %}
    <span class="badge rounded-pill badge-soft-success">Normal</span>
  {% elif t|lower in ['glaucoma suspect','suspect'] %}
    <span class="badge rounded-pill badge-soft-warning">Glaucoma Suspect</span>
  {% elif t|lower == 'glaucoma' %}
    <span class="badge rounded-pill badge-soft-danger">Glaucoma</span>
  {% elif t|lower in ['other retinal','other'] %}
    <span class="badge rounded-pill badge-soft-info">Other Retinal</span>
  {% elif t|lower in ['not gradable','notgradable','ungradable'] %}
    <span class="badge rounded-pill badge-soft-secondary">Not gradable</span>
  {% else %}
    <span class="badge rounded-pill badge-soft-secondary">{{ val or '-' }}</span>
  {% endif %}
{% endmacro %}


<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Image Grading</h3>
</div>

{# Primary CTAs: Start grading flows #}
<div class="mb-3 d-flex flex-wrap align-items-center gap-3">
  <div>
    <a class="btn btn-success btn-lg {% if not start_url %}disabled{% endif %}"
       href="{{ start_url or '#' }}">
      Start Glaucoma Grading
    </a>
    {% if not start_url %}
      <span class="ms-2 text-muted">No ungraded glaucoma images found.</span>
    {% else %}
      <span class="ms-2 small text-muted">Jumps to the most recent ungraded glaucoma image.</span>
    {% endif %}
  </div>
  <div>
    <a class="btn btn-primary btn-lg {% if not start_dr_url %}disabled{% endif %}"
       href="{{ start_dr_url or '#' }}">
      Start DR Grading
    </a>
    {% if not start_dr_url %}
      <span class="ms-2 text-muted">No ungraded DR images found.</span>
    {% else %}
      <span class="ms-2 small text-muted">Jumps to the most recent ungraded DR image.</span>
    {% endif %}
  </div>
  <hr class="w-100 mt-2 mb-0"/>
  </div>

<div class="row g-3 mb-3">
  <div class="col-12 col-md-3">
    <div class="card kpi-card kpi--success shadow-sm h-100">
      <div class="card-body">
        <div class="fw-semibold d-flex align-items-center gap-2"><span class="kpi-icon" aria-hidden="true">üë§</span> My gradings</div>
        <div class="display-6">{{ my_total or 0 }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card kpi-card kpi--primary shadow-sm h-100">
      <div class="card-body">
        <div class="fw-semibold d-flex align-items-center gap-2"><span class="kpi-icon" aria-hidden="true">üëÅÔ∏è</span> Glaucoma gradings</div>
        <div class="display-6">{{ total_glaucoma or 0 }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card kpi-card kpi--info shadow-sm h-100">
      <div class="card-body">
        <div class="fw-semibold d-flex align-items-center gap-2"><span class="kpi-icon" aria-hidden="true">ü©∫</span> DR gradings</div>
        <div class="display-6">{{ total_dr or 0 }}</div>
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="card kpi-card kpi--warning shadow-sm h-100">
      <div class="card-body">
        <div class="fw-semibold d-flex align-items-center gap-2"><span class="kpi-icon" aria-hidden="true">üìä</span> Total gradings</div>
        <div class="display-6">{{ overall_total or 0 }}</div>
        <div class="small text-muted">Unique images: {{ total_unique_images or 0 }}</div>
      </div>
    </div>
  </div>
</div>

<div class="card .theme-jobs shadow-sm mb-3">
  <div class="card-body d-flex flex-wrap align-items-end gap-3">
    <form method="post" class="row g-2 align-items-center">
      {{ csrf_field() }}
      <div class="col-12 col-lg-9">
        <label for="image_uuid" class="form-label mb-0">Code Specific Image</label>
        <div class="input-group input-group-sm">
          <input type="text" class="form-control" id="image_uuid" name="image_uuid" size="60" placeholder="e.g., 550e8400-e29b-41d4-a716-446655440000" required>
          <select class="form-select form-select-sm" name="code_for" aria-label="Grading type" style="max-width: 140px;">
            <option value="glaucoma" selected>Glaucoma</option>
            <option value="dr">DR</option>
            <option value="amd">AMD</option>
          </select>
          <button type="submit" class="btn btn-primary btn-sm">Open</button>
        </div>
      </div>
    </form>

    {# Start button already shown above as the primary CTA #}
  </div>

  </div>

<div class="card card-aurora shadow-sm">
  <div class="card-header d-flex justify-content-between align-items-center">
    <strong>My Gradings</strong>
    <span class="small text-muted">{{ my_total or 0 }} total</span>
  </div>
  <div class="card-body p-0">
    <div class="p-2 border-bottom">
      <div class="d-flex align-items-center gap-3 flex-wrap">
        <div class="d-flex align-items-center gap-2">
          <span class="small text-muted">Impression:</span>
          {% set types = ['all','Normal','Glaucoma Suspect','Glaucoma','Other Retinal','Not gradable'] %}
          <div class="btn-group btn-group-sm" role="group">
            {% for t in types %}
              <a class="btn btn-outline-secondary {% if gimp==t %}active{% endif %}"
                 href="{{ url_for('grading.index', gimp=t, gfor=gfor, p=1) }}">{{ t|capitalize }}</a>
            {% endfor %}
          </div>
        </div>
        <div class="d-flex align-items-center gap-2">
          <span class="small text-muted">Type:</span>
          {% set gfor_opts = ['all','glaucoma','dr','amd'] %}
          <div class="btn-group btn-group-sm" role="group">
            {% for f in gfor_opts %}
              <a class="btn btn-outline-secondary text-uppercase {% if gfor==f %}active{% endif %}"
                 href="{{ url_for('grading.index', gimp=gimp, gfor=f, p=1) }}">{{ f }}</a>
            {% endfor %}
          </div>
        </div>
        {% if type_counts %}
          <span class="ms-auto small text-muted">
            {% for k,v in type_counts.items() %}
              <span class="me-2">{{ k }}: <strong>{{ v }}</strong></span>
            {% endfor %}
          </span>
        {% endif %}
      </div>
    </div>
    <table class="table table-sm table-striped table-hover align-middle mb-0">
      <thead>
        <tr>
          <th style="width: 180px;">Graded At</th>
          <th style="width: 340px;">Image UUID</th>
          <th style="width: 120px;">For</th>
          <th>Result</th>
          <th>Remarks</th>
          <th style="width: 120px;">Action</th>
        </tr>
      </thead>
      <tbody>
      {% if my_items %}
        {% for g in my_items %}
        <tr>
          <td class="text-nowrap">{{ (g.updated_at or g.created_at).strftime('%Y-%m-%d %H:%M') if g.updated_at or g.created_at else '-' }}</td>
          <td class="text-break"><code>{{ g.image.uuid if g.image else '‚Äî' }}</code></td>
          <td class="text-nowrap">{{ badge_for_for(g.graded_for)|safe }}</td>
          <td>{{ badge_for_impression(g.impression)|safe }}</td>
          <td class="small text-muted">{{ g.remarks or '' }}</td>
          <td class="text-end">
            {% if g.image and g.image.uuid %}
            <a class="btn btn-sm btn-outline-primary" href="{{ url_for('grading.glaucoma_image', uuid=g.image.uuid) }}">Revise</a>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="5" class="text-center text-muted p-3">No gradings found.</td></tr>
      {% endif %}
      </tbody>
    </table>
  </div>
  <div class="card-footer d-flex justify-content-between align-items-center">
    <div class="small text-muted">Page {{ my_page }} of {{ my_total_pages }}</div>
    <div class="btn-group btn-group-sm" role="group">
      <a class="btn btn-outline-secondary {% if not my_prev_url %}disabled{% endif %}" href="{{ my_prev_url or '#' }}">Prev</a>
      <a class="btn btn-outline-secondary {% if not my_next_url %}disabled{% endif %}" href="{{ my_next_url or '#' }}">Next</a>
    </div>
  </div>
</div>

{% endblock %}
