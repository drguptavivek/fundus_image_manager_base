{% extends "base.html" %}
{% block title %}Screenings{% endblock %}

{% block content %}
<div class="d-flex align-items-center flex-wrap gap-2 mb-3">
      <h3 class="mb-0 me-2">Patient Screenings</h3>
</div>

<div class="mb-3">
  <div class="row g-2 align-items-center">

    {# LEFT: Search #}
    <div class="col-12 col-lg-4 order-1">
      <form method="get" action="{{ url_for('screenings.list_screenings') }}" role="search">
        <div class="input-group input-group-sm" style="max-width: 520px;">
          <input type="search"
                 name="q"
                 class="form-control"
                 placeholder="Search by Patient ID or Name"
                 value="{{ q or '' }}"
                 aria-label="Search screenings">
          <button class="btn btn-primary" type="submit">Search</button>
          {% if q %}
            <a class="btn btn-outline-secondary" href="{{ url_for('screenings.list_screenings') }}">Clear</a>
          {% endif %}
        </div>
      </form>
    </div>

    {# MIDDLE: Summary #}
    <div class="col-12 col-lg-4 order-3 order-lg-2 text-center">
      <div class="text-muted small toolbar-status">
        {% if q %}
          Showing {{ items|length }} of {{ total }} result{{ 's' if total != 1 else '' }} for “{{ q }}”.
        {% else %}&nbsp;{% endif %}
      </div>
    </div>

    {# RIGHT: Pager #}
    <div class="col-12 col-lg-4 order-2 order-lg-3 d-flex justify-content-lg-end">
      <div class="d-inline-flex align-items-center gap-2">
        <a class="btn btn-outline-secondary btn-sm  {% if not has_prev %}disabled{% endif %}"
           href="{{ prev_url or '#' }}"
           tabindex="{% if not has_prev %}-1{% else %}0{% endif %}">← Prev</a>

        <form class="d-inline" method="get" action="{{ url_for('screenings.list_screenings') }}">
          {% if q %}<input type="hidden" name="q" value="{{ q }}">{% endif %}
          <label for="goto-page" class="visually-hidden">Go to page</label>
          <div class="page-box btn-sm">
            <input type="number"
                   id="goto-page"
                   name="page"
                   class="page-input"
                   inputmode="numeric"
                   min="1"
                   max="{{ total_pages }}"
                   value="{{ page }}"
                   aria-label="Go to page">
            <span class="sep">/ {{ total_pages }}</span>
          </div>
        </form>

        <a class="btn btn-outline-secondary btn-sm {% if not has_next %}disabled{% endif %}"
           href="{{ next_url or '#' }}"
           tabindex="{% if not has_next %}-1{% else %}0{% endif %}">Next →</a>
      </div>
    </div>

  </div>
</div>




{% if items %}
<div class="row g-3">
  {% for enc in items %}
  {# collect images #}
  {% set images = [] %}
  {% for ef in enc.encounter_files %}
  {% if ef.file_type == 'image' %}
  {% set _ = images.append(ef) %}
  {% endif %}
  {% endfor %}
  {% set gallery_id = 'pswp-gallery-enc-' ~ enc.id %}

  <!-- One card per row -->
  <div class="col-12">
    <div class="card scr-card h-100 shadow-sm">
      <!-- Header: Patient / Encounter + Detail button -->
      <div class="card-header py-2">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
          <div class="me-2 flex-grow-1 min-w-0">
            <div class="fw-semibold text-truncate">{{ enc.name or '—' }}</div>

            <div class="d-flex flex-wrap align-items-center gap-2  ">
              <span class="fw-semibold text-body">ID:</span>
              <span class="fw-semibold text-body">{{ enc.patient_id or '—' }}</span>

              <span class="vr d-none d-sm-inline mx-1"></span>
              <span class="fw-semibold text-body">Capture:</span>
              <span class="fw-semibold text-body">{% if enc.capture_date_dt %}{{ enc.capture_date_dt.strftime('%Y-%m-%d') }}{% else %}{{ enc.capture_date or '—' }}{% endif %}</span>

              <!-- ZIP only on md+ -->
              <span class="vr d-none d-md-inline mx-1"></span>
              <span class="text-muted d-none d-md-inline">ZIP:</span>
              <code class="text-break d-none d-md-inline"> {{ enc.zip_file.zip_filename if enc.zip_file else '-' }}
              </code>
            </div>
          </div>

          <div class="d-flex flex-column align-items-end gap-1 text-end">
            <span class="badge scr-badge d-none d-md-inline">#{{ enc.id }}</span>

            <a class="btn btn-primary btn-sm shadow-sm fw-semibold detail-btn px-3"
              href="{{ url_for('screenings.screening_detail', encounter_id=enc.id) }}">
              <span class="me-1" aria-hidden="true">
                <!-- tiny eye icon -->
                <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" focusable="false">
                  <path d="M8 3c3.3 0 5.9 2.1 7.3 4.6a.9.9 0 0 1 0 .8C13.9 11.9 11.3 14 8 14s-5.9-2.1-7.3-4.6a.9.9 0 0 1 0-.8C2.1 5.1 4.7 3 8 3zm0 1.6c-2.6 0-4.7 1.6-6 3.4 1.3 1.8 3.4 3.4 6 3.4s4.7-1.6 6-3.4c-1.3-1.8-3.4-3.4-6-3.4zM8 6.2a2.2 2.2 0 1 1 0 4.4 2.2 2.2 0 0 1 0-4.4z"/>
                </svg>
              </span>
              Screening Detail
            </a>
          </div>


        </div>

      </div>


      <!-- Body: four columns on md+ -->
      <div class="card-body pt-3 pb-2">
        <div class="row scr-grid g-3">
          <!-- DR Report: wider -->
          <div class="col-12 col-lg-4 scr-col">
            <div class="scr-sec-title small text-uppercase text-muted mb-1">DR Report</div>
            {% if enc.dr_reports %}
            <div class="scr-scroll">
              {% for dr in enc.dr_reports %}
              <div class="mb-2">
                <span class="fw-semibold">{{ dr.result or '-' }}</span>
                {% if dr.qualitative_result %}
                <div class="small text-muted">{{ dr.qualitative_result }}</div>
                {% endif %}
                {% if dr.report_file_name %}
                  <div class="mt-2">
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('reports.serve_dr_pdf_by_uuid', uuid=dr.uuid) }}"
                       target="_blank" rel="noopener">Open PDF</a>
                  </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <span class="text-muted">–</span>
            {% endif %}
          </div>

          <!-- Glaucoma Report: wider -->
          <div class="col-12 col-lg-4 scr-col">
            <div class="scr-sec-title small text-uppercase text-muted mb-1">Glaucoma Report</div>
            {% if enc.glaucoma_reports %}
            <div class="scr-scroll">
              {% for gr in enc.glaucoma_reports %}
              <div class="mb-2">
                <span class="fw-semibold">{{ gr.result or '-' }}</span>
                {% if gr.vcdr_right or gr.vcdr_left %}
                <div class="small">VCDR: R={{ gr.vcdr_right or '-' }}, L={{ gr.vcdr_left or '-' }}</div>
                {% endif %}
                {% if gr.qualitative_result %}
                <div class="small text-muted">{{ gr.qualitative_result }}</div>
                {% endif %}
                {% if gr.report_file_name %}
                  <div class="mt-2">
                    <a class="btn btn-sm btn-outline-primary"
                       href="{{ url_for('reports.serve_glaucoma_pdf_by_uuid', uuid=gr.uuid) }}"
                       target="_blank" rel="noopener">Open PDF</a>
                  </div>
                {% endif %}
              </div>
              {% endfor %}
            </div>
            {% else %}
            <span class="text-muted">–</span>
            {% endif %}
          </div>

          <!-- Images -->
          <div class="d-none d-lg-inline col-12 col-lg-3 scr-col">
            <div class="scr-sec-title small text-uppercase text-muted mb-1">Images</div>
            {% set images = [] %}
            {% for ef in enc.encounter_files if ef.file_type == 'image' %}
              {% set _ = images.append(ef) %}
            {% endfor %}
            {% if images %}
              {% set gallery_id = 'pswp-gallery-enc-' ~ enc.id %}
              <div class="small text-body">{{ images|length }} image{{ 's' if images|length != 1 else '' }}</div>
              <button class="btn btn-sm btn-outline-primary mt-2" type="button" onclick="openPswpGallery('{{ gallery_id }}', 0)">View files</button>
              <!-- Hidden PSWP gallery inside Images column -->
              <div id="{{ gallery_id }}" class="pswp-gallery d-none">
                {# Images via UUID #}
                {% for ef in enc.encounter_files if ef.file_type == 'image' %}
                <a href="{{ url_for('media.serve_file_by_uuid', uuid=ef.uuid) }}" data-pswp-type="image" title="Image"></a>
                {% endfor %}
                {# PDFs via Report UUIDs (split pages) #}
                {% for dr in enc.dr_reports if dr.report_file_name %}
                <a href="{{ url_for('reports.serve_dr_pdf_by_uuid', uuid=dr.uuid) }}" data-pswp-type="html"
                   data-pswp-html="<div class='pswp__pdfwrap'><iframe src='{{ url_for('reports.serve_dr_pdf_by_uuid', uuid=dr.uuid) | e }}' title='DR PDF' frameborder='0'></iframe></div>"
                   title="DR PDF"></a>
                {% endfor %}
                {% for gr in enc.glaucoma_reports if gr.report_file_name %}
                <a href="{{ url_for('reports.serve_glaucoma_pdf_by_uuid', uuid=gr.uuid) }}" data-pswp-type="html"
                   data-pswp-html="<div class='pswp__pdfwrap'><iframe src='{{ url_for('reports.serve_glaucoma_pdf_by_uuid', uuid=gr.uuid) | e }}' title='Glaucoma PDF' frameborder='0'></iframe></div>"
                   title="Glaucoma PDF"></a>
                {% endfor %}
              </div>
            {% else %}
              <span class="text-muted small">No images</span>
            {% endif %}
          </div>

          
        </div>
      </div>

      <!-- Optional: remove footer to keep it compact -->
      {# <div class="card-footer bg-transparent"></div> #}
    </div>
  </div>
  {% endfor %}
  </div>
{% else %}
<div class="text-center text-muted p-4">No screenings found.</div>
{% endif %}

<!-- Bottom pager (retained) -->
<div class="d-flex justify-content-between align-items-center mt-3">
  <div class="text-muted small">
    Showing page {{ page }} of {{ total_pages }} · {{ total }} total
  </div>
  <nav>
    <ul class="pagination mb-0">
      <li class="page-item {% if not has_prev %}disabled{% endif %}">
        <a class="page-link" href="{{ prev_url or '#' }}">Previous</a>
      </li>
      <li class="page-item disabled">
        <span class="page-link">Page {{ page }}</span>
      </li>
      <li class="page-item {% if not has_next %}disabled{% endif %}">
        <a class="page-link" href="{{ next_url or '#' }}">Next</a>
      </li>
    </ul>
  </nav>
</div>

<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true"></div>
<br/>
<br/>
{% endblock %}

{% block page_scripts %}
<script src="{{ url_for('static', filename='js/photoswipe.umd.min.js') }}?v={{ v }}"></script>
<script src="{{ url_for('static', filename='js/photoswipe-lightbox.umd.min.js') }}?v={{ v }}"></script>
<script src="{{ url_for('static', filename='js/pswp-init.js') }}?v={{ v }}"></script>
{% endblock %}
