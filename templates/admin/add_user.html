{% extends "base.html" %}
{% block title %}Add User{% endblock %}
 
{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h1 class="h4 mb-0">Add User</h1>
        <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('admin.users_list') }}">Back to Users</a>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">


            <form method="post" action="{{ url_for('admin.add_user') }}" novalidate data-password-policy="1"
                data-username-policy="1" data-username-min="3" data-minlen="10"
                data-commons="123,qwerty,abcd,xyz,password,aiims" data-allowed-specials="@#!&">

                {{ csrf_field() }}

                <div class="row g-3">
                    <div class="col-md-6">
                        <label for="username" class="form-label">Username <span class="text-danger">*</span></label>
                        <!-- Username -->
                        <input type="text" class="form-control" id="username" name="username" required minlength="3"
                            maxlength="150" pattern="[A-Za-z0-9]+" title="Use only English letters and digits.">
                    </div>

                    <div class="col-md-3">
                        <label class="form-label d-block">Status</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="active" name="active" value="1" {% if
                                active %}checked{% endif %}>
                            <label class="form-check-label" for="active">Active</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label for="file_upload_quota" class="form-label">File Upload Quota</label>
                        <input type="number" class="form-control" id="file_upload_quota" name="file_upload_quota"
                            value="{{ file_upload_quota or 0 }}" min="0" required>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Roles</label>
                        <div class="d-flex flex-wrap gap-3">
                            {% for r in roles %}
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="role-{{ r.name }}" name="roles"
                                    value="{{ r.name }}" {% if r.name in (selected_roles or []) %}checked{% endif %}>
                                <label class="form-check-label" for="role-{{ r.name }}">{{ r.name }}</label>
                            </div>
                            {% endfor %}
                            {% if not roles %}
                            <div class="text-muted small">No roles defined yet.</div>
                            {% endif %}
                        </div>
                    </div>

                    <div class="col-12">
                        <label class="form-label">Associated Lab Units</label>
                        {% if hospitals %}
                        <div class="row g-2">
                            {% for hospital in hospitals %}
                            <div class="col-md-6">
                                <div class="card card-body bg-light p-2">
                                    <h6 class="mb-2">{{ hospital.name }}</h6>
                                    {% for lu in lab_units if lu.hospital_id == hospital.id %}
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="labunit-{{ lu.id }}"
                                            name="lab_units" value="{{ lu.id }}" {% if lu.id in (selected_lab_units or []) %}checked{% endif %}>
                                        <label class="form-check-label" for="labunit-{{ lu.id }}">{{ lu.name }}</label>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="text-muted small">No hospitals or lab units defined yet.</div>
                        {% endif %}
                    </div>

                    <div class="col-md-6">
                        <label for="new_password" class="form-label">Password <span class="text-danger">*</span></label>
                        <!-- Password -->
                        <input type="password" class="form-control" id="new_password" name="new_password" required
                            minlength="10" pattern="[A-Za-z0-9@#!&]+"
                            title="Use only letters, digits, and @ # ! &; must include uppercase, lowercase, and one of @ # ! &.">

                        <div class="form-text">Minimum 10 characters. Use only letters, digits, and @ # ! &; must
                            include uppercase, lowercase, and one of @ # ! &</div>
                    </div>

                    <div class="col-md-6">
                        <label for="confirm_password" class="form-label">Confirm Password <span
                                class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password"
                            required minlength="10" pattern="[A-Za-z0-9@#!&]+" autocomplete="new-password">
                    </div>
                </div>
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label" for="full_name">Full name</label>
                        <input class="form-control" id="full_name" name="full_name" value="{{ full_name or '' }}"
                            maxlength="200">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="designation">Designation</label>
                        <input class="form-control" id="designation" name="designation" value="{{ designation or '' }}"
                            maxlength="100">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="email">Email</label>
                        <input class="form-control" id="email" name="email" type="email" value="{{ email or '' }}"
                            maxlength="254">
                    </div>
                    <div class="col-md-6">
                        <label class="form-label" for="phone">Phone</label>
                        <input class="form-control" id="phone" name="phone" value="{{ phone or '' }}"
                            pattern="[0-9+\-\s()]{7,}" maxlength="32" title="Digits, + - ( ) and spaces">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="year_of_joining">Year of joining</label>
                        <input class="form-control" id="year_of_joining" name="year_of_joining" inputmode="numeric"
                            pattern="[0-9]{4}" value="{{ year_of_joining or '' }}" title="YYYY">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label" for="last_date_of_service">Last date of service</label>
                        <input class="form-control" id="last_date_of_service" name="last_date_of_service" type="date"
                            value="{{ last_date_of_service or '' }}">
                    </div>
                </div>


                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Create user</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}



{% block page_scripts %}
<script src="{{ url_for('static', filename='js/password-policy.js') }}?v={{ v }}" defer></script>
{% endblock %}