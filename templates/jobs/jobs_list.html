{% extends "base.html" %}
{% block title %}Recent Jobs{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="mb-0">Recent Jobs</h3>
  <a class="btn btn-secondary" href="{{ url_for('uploads.upload_form') }}">Upload</a>
</div>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <table class="table table-hover mb-0">
      <thead class="table-light">
        <tr>
          <th style="width: 160px;">Created (UTC)</th>
          <th>Token</th>
          <th>Uploaded By</th>
          <th>Uploader IP</th>
          <th style="width: 160px;">Status</th>
          <th>Error</th>
          <th>Rejected</th>
          <th style="width: 100px;">Open</th>
        </tr>
      </thead>
      <tbody>
      {% for j in jobs %}
        <tr>
          <td>{{ j.created_at.strftime('%Y-%m-%d %H:%M:%S') if j.created_at else '-' }}</td>
          <td><code>{{ j.token }}</code></td>
          <td>{{ j.uploader_username or '-' }}</td>
          <td><code>{{ j.uploader_ip or '-' }}</code></td>
          <td>
            {% set c = 'secondary' %}
            {% if j.status == 'queued' %}{% set c='secondary' %}
            {% elif j.status == 'processing' %}{% set c='warning text-dark' %}
            {% elif j.status == 'done' %}{% set c='success' %}
            {% elif j.status == 'error' %}{% set c='danger' %}{% endif %}
            <div class="d-flex gap-2 align-items-center">
              <span class="badge bg-{{ c }}">{{ j.status or 'unknown' }}</span>
              {% if rejections and rejections.get(j.id, 0) > 0 %}
                <span class="badge bg-danger">Rejected</span>
              {% endif %}
            </div>
          </td>
          <td class="small text-muted">{{ (j.error or '')[:120] }}</td>
          <td class="small text-muted">
            {% if rejections and rejections.get(j.id, 0) > 0 %}
              <span class="badge bg-danger me-1">{{ rejections.get(j.id) }}</span>
            {% endif %}
            {{ (j.rejected_summary or '')[:120] }}
          </td>
          <td>
            <a class="btn btn-sm btn-outline-primary"
               href="{{ url_for('jobs.job_status_page', job_token=j.token) }}">
              View
            </a>
          </td>
        </tr>
      {% else %}
        <tr><td colspan="6" class="text-center text-muted p-4">No jobs yet.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<div class="mt-3 text-end">
  <a class="btn btn-outline-secondary" href="/healthz">Health</a>
</div>
{% endblock %}
